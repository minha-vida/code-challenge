
@{
    ViewData["Title"] = "Carteira";
}
<environment include="Development">
    <script src="~/js/Vaccines.js" asp-append-version="true" type="text/javascript"></script>
</environment>

<h3>Minha Carteira</h3>
<div class="col-md-12">
    <div class="well">
        <input type="button" class="btn btn-primary" id="Add_Vacc" data-toggle="modal" data-target="#ModalVacina" value="Adicionar Vacina" />
    </div>
</div>
<div id="Panel_Vaccs" class="col-md-12">
    <div id="listVaccs" class="list-group">

    </div>
</div>
<div id="ModalVacina" class="modal fade" tabindex="-1" role="dialog">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                <h4 class="modal-title">Criar Nova Vacina</h4>
            </div>
            <div class="modal-body">
                <br />
                <label for="">Vacina:</label>
                <input type="text" id="Vacc_Name" class="form-control" />
                <input type="hidden" id="Vacc_Old_Name" value="" />
                <br />
                <label for="">Aplicada em:</label>
                <input type="text" id="Vacc_Applied" class="form-control" />
                <input type="hidden" id="Vacc_Applied_Old" value="" />
                <br />
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-default" data-dismiss="modal">Cancelar</button>
                <button type="button" id="Vacc_OK" class="btn btn-primary">Salvar</button>
            </div>
        </div>
    </div>
</div>
<script type="text/javascript">
    $(document).ready(function () {
        JohnnyGoAjaxStyle("", "@Url.Action("VisualizarVacinas", "Carteira")", LoadVaccines, Failure);
    });

    $("#ModalVacina").on("show.bs.modal", function (event) { 
        var element = $(event.relatedTarget);
        var nameVacc = element.data('vacname'), dateVacc = element.data('vacdate');

        if (typeof nameVacc !== 'undefined' && typeof dateVacc !== 'undefined') {
            document.getElementById("Vacc_Old_Name").value = nameVacc;
            document.getElementById("Vacc_Name").value = nameVacc;
            document.getElementById("Vacc_Applied_Old").value = dateVacc;
            document.getElementById("Vacc_Applied").value = dateVacc;

            $(".modal-title").text("Editar Vacina");
        }
        else
            $(".modal-title").text("Criar Nova Vacina");
    });

    $("#ModalVacina").on("hide.bs.modal", function () { 
        document.getElementById("Vacc_Old_Name").value =
        document.getElementById("Vacc_Name").value = 
        document.getElementById("Vacc_Applied_Old").value = 
        document.getElementById("Vacc_Applied").value = "";
    });

    $("#Vacc_OK").on("click", function () {
        var name = document.getElementById("Vacc_Name").value;
        var appDate = document.getElementById("Vacc_Applied").value;
        var nameOld = document.getElementById("Vacc_Old_Name").value;
        var appDateOld = document.getElementById("Vacc_Applied_Old").value;

        if (nameOld !== "" || appDateOld !== "") {
            if (nameOld !== name || appDateOld !== appDate) {
                JohnnyGoAjaxStyle(SetVaccineObjectEdit(nameOld, appDateOld, name, appDate), "@Url.Action("AlterarVacina", "Carteira")", UpdateVaccine, Failure);
            }
        }
        else
            JohnnyGoAjaxStyle(SetVaccineObject(name, appDate), "@Url.Action("CriarVacina", "Carteira")", AddSuccess, Failure);
    });

    function CreateItemOnScreen(VaccObj) {
        var item = "<button type='button' class='list-group-item' name='" + VaccObj.vaccineName +"'><span class='badge'><a href='#' class='fas fa-edit inverseTextColor' \
        data-vacname='"+ VaccObj.vaccineName.trim() + "' data-vacdate='" + AdjustDateVaccine(VaccObj.appliedAt) + "' data-toggle='modal' data-target='#ModalVacina'></a>\
<a href='#' onclick='RemoveVaccine(this);' class='fas fa-eraser inverseTextColor' data-vacname='"+ VaccObj.vaccineName + "' data-vacdate='" + AdjustDateVaccine(VaccObj.appliedAt) + "'></a></span> "
            + VaccObj.vaccineName + " - Aplicada em: "
            + AdjustDateVaccine(VaccObj.appliedAt) + "</button>";

        $("#listVaccs").append(item);
    }

    function RemoveItemOnScreen(elementName) {
        var element = document.getElementsByName(elementName);
        $(element).remove();
    }

    function LoadVaccines(data) {
        var dataVacc = data;

        for (var vaccine in data) {
            if (data.hasOwnProperty(vaccine))
                CreateItemOnScreen(data[vaccine]);
        }
    }

    function AddSuccess(data) {
        var dataVacc = data;
        CreateItemOnScreen(data);

        $("#ModalVacina").modal("hide");
    }

    function UpdateVaccine(vaccObj) {
        if (typeof vaccObj !== 'undefined') {
            var elementToChange = document.getElementById("Vacc_Old_Name").value;
            RemoveItemOnScreen(elementToChange);
            CreateItemOnScreen(vaccObj);

            $("#ModalVacina").modal("hide");
        }
    }

    function RemoveVaccine(element) {
        var nameVacc = $(element).data('vacname'), dateVacc = $(element).data('vacdate');

        if (typeof nameVacc !== 'undefined' && typeof dateVacc !== 'undefined') {
            JohnnyGoAjaxStyle(SetVaccineObject(nameVacc, dateVacc), "@Url.Action("RemoverVacina", "Carteira")", RemoveElement, Failure);
        }
    }

    function RemoveElement(vaccObj) {
        if (typeof vaccObj !== 'undefined') {
            var elementToChange =vaccObj.vaccineName;
            RemoveItemOnScreen(elementToChange);
        }
    }

    function Failure() {

    }
</script>
